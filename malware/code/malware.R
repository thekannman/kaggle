#library('e1071')
library(lubridate)
#library('randomForest')
#library('cvTools')
library(caret)
library(caretEnsemble)
library(Metrics)
library(doMC)
registerDoMC(cores=1)

is.nan.data.frame <- function(x)
do.call(cbind, lapply(x, is.nan))


logloss <- function (data, lev = NULL, model = NULL) {
    LogLos <- function(actual, pred, eps = 1e-15) {
        stopifnot(all(dim(actual) == dim(pred)))
        pred[pred < eps] <- eps
        pred[pred > 1 - eps] <- 1 - eps
        -sum(actual * log(pred)) / nrow(pred)
    }
    if (is.character(data$obs)) data$obs <- factor(data$obs, levels = lev)
    pred <- data[, "pred"]
    obs <- data[, "obs"]
    isNA <- is.na(pred)
    pred <- pred[!isNA]
    obs <- obs[!isNA]
    data <- data[!isNA, ]
    cls <- levels(obs)
  
    if (length(obs) + length(pred) == 0) {
        out <- rep(NA, 2)
    } else {
        pred <- factor(pred, levels = levels(obs))
        require("e1071")
        out <- unlist(e1071::classAgreement(table(obs, pred)))[c("diag", "kappa")]
        probs <- data[, cls]
        actual <- model.matrix(~ obs - 1)
        out2 <- LogLos(actual = actual, pred = probs)
    }
    out <- c(out, out2)
    names(out) <- c("Accuracy", "Kappa", "LogLoss")

    if (any(is.nan(out))) out[is.nan(out)] <- NA 
    out
}
rfFuncs$summary = logloss

train <- read.csv(gzfile("../train_nofourbit.gz"))
test <- read.csv(gzfile("../test_nofourbit.gz"))
train_labels <- read.csv("../trainLabels.csv")
colnames(train)[1] = "Id"
train_new <- merge(train, train_labels, by="Id")

train_cols<-train_new[,c(2:260)]
train_cols$max <- apply(train_cols[4:259],1,max)
train_cols$min <- apply(train_cols[4:259],1,min)
#train_cols$which.min = as.factor(apply(train_cols[4:259],1,which.min))
#train_cols$which.max = as.factor(apply(train_cols[4:259],1,which.max))
train_cols$med <- apply(train_cols[4:259],1,median)
train_cols$sd <- apply(train_cols[4:259],1,sd)
for (i in 1:256)
{
    col.name <- paste("order",i,sep="")
    train_cols[,col.name] <- 0.0
}
two.byte.names <- colnames(train_cols[,4:259])
for (i in 1:nrow(train_cols))
{
    train_cols[i,264:519] <- as.numeric(match(two.byte.names, colnames(sort(train_cols[i,4:259], decreasing=T))))
}

train_cols$perc_que_mark <- train_cols$no_que_mark/train_cols$file_size
train_cols$two_over_que <- train_cols$two_byte_sum/train_cols$no_que_mark
train_cols$med_over_max <- train_cols$med/train_cols$max
train_cols$med_over_min <- train_cols$med/train_cols$min
train_cols$min_over_max <- train_cols$min/train_cols$max
train_cols$sd_over_max <- train_cols$sd/train_cols$max
train_cols$sd_over_med <- train_cols$sd/train_cols$med
train_cols$sd_over_min <- train_cols$sd/train_cols$min
for (i in 1:255)
{
    col.name <- paste("TB_0_over_",as.hexmode(i),sep="")
    train_cols[,col.name] <- train_cols$TB_0/train_cols[,paste("TB_",as.hexmode(i),sep="")]
}
for (i in 1:255)
{
    col.name <- paste("TB_8b_over_",as.hexmode(i),sep="")
    train_cols[,col.name] <- train_cols$TB_8b/train_cols[,paste("TB_",as.hexmode(i),sep="")]
}
train_cols[is.nan(train_cols)] <- 0
train_cols <- do.call(data.frame,lapply(train_cols, function(x) replace(x, is.infinite(x),0)))

labels<-train_new[,261]
labels<-as.factor(paste("X",labels,sep=""))

testdata<-test[,2:260]
testdata$max <- apply(testdata[4:259],1,max)
testdata$min <- apply(testdata[4:259],1,min)
testdata$med <- apply(testdata[4:259],1,median)
testdata$sd <- apply(testdata[4:259],1,sd)
for (i in 1:256)
{
    col.name <- paste("order",i,sep="")
    testdata[,col.name] <- 0.0
}

testdata$perc_que_mark <- testdata$no_que_mark/testdata$file_size
testdata$two_over_que <- testdata$two_byte_sum/testdata$no_que_mark
testdata$med_over_max <- testdata$med/testdata$max
testdata$med_over_min <- testdata$med/testdata$min
testdata$min_over_max <- testdata$min/testdata$max
testdata$sd_over_max <- testdata$sd/testdata$max
testdata$sd_over_med <- testdata$sd/testdata$med
testdata$sd_over_min <- testdata$sd/testdata$min
for (i in 1:255)
{
    col.name <- paste("TB_0_over_",as.hexmode(i),sep="")
    testdata[,col.name] <- testdata$TB_0/testdata[,paste("TB_",as.hexmode(i),sep="")]
}
for (i in 1:255)
{
    col.name <- paste("TB_8b_over_",as.hexmode(i),sep="")
    testdata[,col.name] <- testdata$TB_8b/testdata[,paste("TB_",as.hexmode(i),sep="")]
}
testdata[is.nan(testdata)] <- 0
testdata <- do.call(data.frame,lapply(testdata, function(x) replace(x, is.infinite(x),0)))


for (i in 1:nrow(train_cols))
{
    testdata[i,264:519] <- match(two.byte.names, colnames(sort(testdata[i,4:259], decreasing=T)))
}



#train_cols <- data.frame(lapply(train_cols,as.numeric))
#testdata<-data.frame(lapply(testdata,as.numeric))

#fit.rf <- randomForest(revenue ~ ., data=train)
#print(fit.rf)
#importance(fit.rf)
#plot(fit.rf)
#plot( importance(fit.rf), lty=2, pch=16)
#lines(importance(fit.rf))
#imp = importance(fit.rf)
#tmp <- createFolds(labels, k=100, list=TRUE)
ctrl <- trainControl(method="cv", number=10, classProbs=T, savePred=T, summaryFunction = logloss)
#set.seed(1500)
tuneGrid <- data.frame(mtry=130)
#mod <- train(x=as.matrix(train_cols),y=as.vector(labels),method="rf",trControl=ctrl, ntree=5001)#,tuneGrid=tuneGrid)
mod <- train(x=as.matrix(train_cols),y=labels,method="rf",trControl=ctrl, ntree=501, tuneGrid=tuneGrid, maximize=F,metric='LogLoss')
#mod
#predictions<-as.data.frame(predict(mod,newdata=testdata))

#gaussprPoly too slow
#I think bdk works but it is likely slow.
#gbm,bagFDA,logicBag,bagEarthGCV,bag,avNNet,rFerns,extraTrees, failed
#mtry=130 optimal for rf and parRF
#wsrf fails due to ‘“Rcpp” version 0.11.4 cannot be unloaded.’, likely fixable
method_list = c('cforest','RRF','RRFglobal','parRF','rf','kernelpls','knn','pls','rpart','rpart2','simpls','spls','svmPoly','svmRadial','svmRadialCost','treebag','widekernelpls','xyf','rf','extraTrees')
mod <- caretList(x=as.matrix(train_cols),maximize=F,y=labels,methodList=method_list,trControl=ctrl, metric='LogLoss')
greedy_ensemble <- caretEnsemble(mod)
summary(greedy_ensemble)
predictions<-as.data.frame(predict(mod,newdata=testdata, type="prob"))

submit<-as.data.frame(cbind(test[,1],predictions))
colnames(submit)<-c("Id","Prediction1","Prediction2","Prediction3","Prediction4","Prediction5","Prediction6","Prediction7","Prediction8","Prediction9")
write.csv(submit,format(Sys.time(), "%m-%d_%H:%M_submission.csv"),row.names=FALSE,quote=FALSE)
